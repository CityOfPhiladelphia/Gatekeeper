Ext.define("Site.page.Endpoints",{singleton:true,constructor:function(){var a=this;a.endpoints=new Ext.util.Collection({listeners:{scope:a,sort:"onSort"}});a.requestsRenderer=Ext.util.Format.numberRenderer("0,000");Ext.onReady(a.onDocReady,a)},onDocReady:function(){var b=this,a=b.endpoints,c=b.endpointsCt=Ext.getBody().down(".endpoints");Ext.getBody().on("click",function(e,d){var f=e.getTarget(".endpoint",null,true);f.toggleCls("expanded")},null,{delegate:".endpoint"});c.select(".endpoint",true).each(function(h){var g=h.down("header"),e=g.insertFirst({cls:"metric-primary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit",html:"requests"}]}),d=g.insertFirst({cls:"metric-secondary-ct",cn:[{cls:"metric-secondary-bar"},{cls:"metric-secondary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit",html:"ms"}]}]}),f=g.insertFirst({cls:"metric-secondary-ct",cn:[{cls:"metric-secondary-bar"},{cls:"metric-secondary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit",html:"%"}]}]});h.setVisibilityMode(Ext.Element.DISPLAY);a.add({id:parseInt(h.getAttribute("data-id"),10),el:h,title:h.down(".title").dom.innerText,responseTimeBarEl:d.down(".metric-secondary-bar"),responseTimeValueEl:d.down(".metric-secondary-value .number"),cacheHitRatioBarEl:f.down(".metric-secondary-bar"),cacheHitRatioValueEl:f.down(".metric-secondary-value .number"),requestsBarEl:g.insertFirst({cls:"metric-primary-bar"}),requestsValueEl:e.down(".number")})});c.down("input[type=search]").on("keyup","onFilterKeyUp",b);a.suspendEvent("sort");a.setSorters(function(g,e){var i=g.lastMetrics,f=i&&i.requests,h=e.lastMetrics,d=h&&h.requests;if(f==d){return 0}return f>d?-1:1});b.loadMetrics(function(){a.resumeEvent("sort")})},onSort:function(a){var c=this,b=0,e=c.endpointsCt,d=a.getCount();for(;b<d;b++){e.appendChild(a.getAt(b).el)}},onFilterKeyUp:function(b,a){var d=a.value,c=new RegExp(d,"i");this.endpoints.each(function(e){e.el.setVisible(c.test(e.title))})},loadMetrics:function(c,d){var e=this,b=e.requestsRenderer,a=e.endpoints,f=a.getCount();Ext.Ajax.request({url:"/metrics/endpoints-current",headers:{Accept:"application/json"},success:function(h){var g=Ext.decode(h.responseText,true),n=g&&g.data,l=n&&n.length,j,p,o,k=0,m=0;if(!n){console.error("Failed to load endpoints");return}for(j=0;j<l;j++){p=n[j];k+=p.requests;m=Math.max(m,p.responseTime);a.getByKey(p.EndpointID).lastMetrics=p}Ext.callback(c,d);a.sort();Ext.defer(function(){var q=0,u,s,t,v,r;for(;q<f;q++){u=a.getAt(q);s=u.lastMetrics;v=s.requests;u.requestsBarEl.setStyle("width",Math.round(v/k*100)+"%");u.requestsValueEl.update(b(v));t=s.responseTime;u.responseTimeBarEl.setStyle("height",Math.round(t/m*100)+"%");u.responseTimeValueEl.update(t);r=v?Math.round(s.responsesCached/v*100):0;u.cacheHitRatioBarEl.setStyle("height",r+"%");u.cacheHitRatioValueEl.update(r.toString())}},1);if(!e.updatesPaused){Ext.defer(e.loadMetrics,2000,e)}}})}});