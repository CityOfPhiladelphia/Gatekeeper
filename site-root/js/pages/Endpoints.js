Ext.define("Site.page.Endpoints",{singleton:true,responseTimeClsLevels:{good:0,mid:150,bad:1000},constructor:function(){var a=this;a.endpoints=new Ext.util.Collection({listeners:{scope:a,sort:"onSort"}});a.requestsRenderer=a.bytesRenderer=Ext.util.Format.numberRenderer("0,000");Ext.onReady(a.onDocReady,a)},onDocReady:function(){var c=this,a=c.endpoints,d=c.endpointsCt=Ext.getBody().down(".endpoints"),b;Ext.getBody().on("click",function(f,e){if(f.getTarget("a")){return}var g=f.getTarget(".endpoint",null,true);g.toggleCls("expanded")},null,{delegate:".endpoint .summary"});d.select(".endpoint",true).each(function(j){var h=j.down(".summary"),f=j.down(".title"),g=f.appendChild({cls:"metric-primary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit"}]}),e=h.appendChild({cls:"metric-secondary-ct",cn:[{cls:"metric-secondary-bar"},{cls:"metric-secondary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"}]}]}),i=h.appendChild({cls:"metric-secondary-ct",cn:[{cls:"metric-secondary-bar"},{cls:"metric-secondary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit percent",html:"%"}]}]});j.setVisibilityMode(Ext.Element.DISPLAY);a.add({id:parseInt(j.getAttribute("data-id"),10),el:j,title:f.dom.innerText,responseTimeCt:e,responseTimeBarEl:e.down(".metric-secondary-bar"),responseTimeValueEl:e.down(".metric-secondary-value .number"),cacheHitRatioCt:i,cacheHitRatioBarEl:i.down(".metric-secondary-bar"),cacheHitRatioValueEl:i.down(".metric-secondary-value .number"),primaryBarEl:f.insertFirst({cls:"metric-primary-bar"}),primaryValueEl:g.down(".number"),primaryUnitEl:g.down(".unit")})});d.down("input[type=search]").on("keyup","onFilterKeyUp",c);d.select("input[name=mode]",true).on("change","onModeChange",c);b=d.down("input[name=mode]:checked");c.mode=b?b.getValue():"requests";a.suspendEvent("sort");a.setSorters(function(f,e){var k=c.mode,j=f.lastMetrics,h=j&&(k=="requests"?j.requests:j.bytesTotal),i=e.lastMetrics,g=i&&(k=="requests"?i.requests:i.bytesTotal);if(h==g){return 0}return h>g?-1:1});c.loadMetrics(function(){a.resumeEvent("sort")})},onSort:function(c){var e=this,h=e.endpointsCt,g=c.getCount(),f=e.lastOrder,a=e.lastOrder=Ext.Array.pluck(c.items,"id"),b=true,d;if(a&&f){for(d=0;d<g;d++){if(a[d]!=f[d]){b=false;break}}if(b){return}}for(d=0;d<g;d++){h.appendChild(c.getAt(d).el)}},onFilterKeyUp:function(b,a){var d=a.value,c=new RegExp(d,"i");this.endpoints.each(function(e){e.el.setVisible(c.test(e.title))})},onModeChange:function(c,a){var b=this;b.mode=a.value;b.endpoints.sort();Ext.defer(b.renderMetrics,1,b)},loadMetrics:function(b,c){var d=this,a=d.endpoints;Ext.Ajax.request({url:"/metrics/endpoints-current",headers:{Accept:"application/json"},success:function(f){var k=Ext.decode(f.responseText,true),j=k&&k.data,g=j&&j.length,h=0,e;if(!j){console.error("Failed to load endpoints");return}for(;h<g;h++){e=j[h];e.bytesTotal=e.bytesCached+e.bytesExecuted;a.getByKey(e.EndpointID).lastMetrics=e}Ext.callback(b,c);a.sort();Ext.defer(d.renderMetrics,1,d);if(!d.updatesPaused){Ext.defer(d.loadMetrics,2000,d)}}})},renderMetrics:function(){var s=this,n=s.mode,g=s.endpoints,t=g.getCount(),m=n=="requests"?s.requestsRenderer:s.bytesRenderer,h=s.responseTimeClsLevels,j=Ext.Array.max(Ext.Object.getValues(h)),d=Ext.Object.getKeys(h),b=0,a=0,q=0,r,f,p,e,c,o,l,k;for(r=0;r<t;r++){f=g.getAt(r);p=f.lastMetrics;b+=p.requests;a+=p.bytesTotal;q=Math.max(q,p.responseTime)}q=Math.min(q,j);for(r=0;r<t;r++){f=g.getAt(r);p=f.lastMetrics;c=p.requests;o=p.bytesTotal;f.primaryBarEl.setStyle("width",Math.round((n=="requests"?c/b:o/a)*100)+"%");f.primaryValueEl.update(m(n=="requests"?c:o));f.primaryUnitEl.update(n+" / hour");e=p.responseTime;k=f.responseTimeCt;f.responseTimeBarEl.setStyle("height",Math.min(Math.round(e/q*100),100)+"%");f.responseTimeValueEl.update(e||"&mdash;");k.removeCls(d);if(e){k.addCls(s.getResponseTimeCls(e))}l=Math.round((n=="requests"?(c?p.responsesCached/c:0):(o?p.bytesCached/o:0))*100);f.cacheHitRatioBarEl.setStyle("height",l+"%");f.cacheHitRatioValueEl.update(l.toString())}},getResponseTimeCls:function(b){var a=this.responseTimeClsLevels,d,c;for(d in a){if(!a.hasOwnProperty(d)){continue}if(b>=a[d]){c=d}else{break}}return c}});