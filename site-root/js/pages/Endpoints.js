Ext.define("Site.page.Endpoints",{singleton:true,responseTimeClsLevels:{good:0,mid:150,bad:1000},constructor:function(){var a=this;a.endpoints=new Ext.util.Collection({listeners:{scope:a,sort:"onSort"}});a.requestsRenderer=Ext.util.Format.numberRenderer("0,000");Ext.onReady(a.onDocReady,a)},onDocReady:function(){var b=this,a=b.endpoints,c=b.endpointsCt=Ext.getBody().down(".endpoints");Ext.getBody().on("click",function(e,d){if(e.getTarget("a")){return}var f=e.getTarget(".endpoint",null,true);f.toggleCls("expanded")},null,{delegate:".endpoint .summary"});c.select(".endpoint",true).each(function(i){var g=i.down(".summary"),e=i.down(".title"),f=e.appendChild({cls:"metric-primary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit",html:"requests"}]}),d=g.appendChild({cls:"metric-secondary-ct",cn:[{cls:"metric-secondary-bar"},{cls:"metric-secondary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit",html:"ms"}]}]}),h=g.appendChild({cls:"metric-secondary-ct",cn:[{cls:"metric-secondary-bar"},{cls:"metric-secondary-value",cn:[{tag:"span",cls:"number",html:"&mdash;"},{tag:"span",cls:"unit",html:"%"}]}]});i.setVisibilityMode(Ext.Element.DISPLAY);a.add({id:parseInt(i.getAttribute("data-id"),10),el:i,title:e.dom.innerText,responseTimeCt:d,responseTimeBarEl:d.down(".metric-secondary-bar"),responseTimeValueEl:d.down(".metric-secondary-value .number"),cacheHitRatioCt:h,cacheHitRatioBarEl:h.down(".metric-secondary-bar"),cacheHitRatioValueEl:h.down(".metric-secondary-value .number"),requestsBarEl:e.insertFirst({cls:"metric-primary-bar"}),requestsValueEl:f.down(".number")})});c.down("input[type=search]").on("keyup","onFilterKeyUp",b);a.suspendEvent("sort");a.setSorters(function(g,e){var i=g.lastMetrics,f=i&&i.requests,h=e.lastMetrics,d=h&&h.requests;if(f==d){return 0}return f>d?-1:1});b.loadMetrics(function(){a.resumeEvent("sort")})},onSort:function(c){var e=this,h=e.endpointsCt,g=c.getCount(),f=e.lastOrder,a=e.lastOrder=Ext.Array.pluck(c.items,"id"),b=true,d;if(a&&f){for(d=0;d<g;d++){if(a[d]!=f[d]){b=false;break}}if(b){return}}for(d=0;d<g;d++){h.appendChild(c.getAt(d).el)}},onFilterKeyUp:function(b,a){var d=a.value,c=new RegExp(d,"i");this.endpoints.each(function(e){e.el.setVisible(c.test(e.title))})},loadMetrics:function(g,i){var f=this,b=f.requestsRenderer,a=f.endpoints,c=a.getCount(),h=f.responseTimeClsLevels,d=Ext.Array.max(Ext.Object.getValues(h)),e=Ext.Object.getKeys(h);Ext.Ajax.request({url:"/metrics/endpoints-current",headers:{Accept:"application/json"},success:function(k){var j=Ext.decode(k.responseText,true),p=j&&j.data,n=p&&p.length,l,s,q,m=0,o=0;if(!p){console.error("Failed to load endpoints");return}for(l=0;l<n;l++){s=p[l];m+=s.requests;o=Math.max(o,s.responseTime);a.getByKey(s.EndpointID).lastMetrics=s}o=Math.min(o,d);Ext.callback(g,i);a.sort();Ext.defer(function(){var t=0,x,v,w,y,u,r;for(;t<c;t++){x=a.getAt(t);v=x.lastMetrics;y=v.requests;x.requestsBarEl.setStyle("width",Math.round(y/m*100)+"%");x.requestsValueEl.update(b(y));w=v.responseTime;r=x.responseTimeCt;x.responseTimeBarEl.setStyle("height",Math.min(Math.round(w/o*100),100)+"%");x.responseTimeValueEl.update(w||"&mdash;");r.removeCls(e);if(w){r.addCls(f.getResponseTimeCls(w))}u=y?Math.round(v.responsesCached/y*100):0;x.cacheHitRatioBarEl.setStyle("height",u+"%");x.cacheHitRatioValueEl.update(u.toString())}},1);if(!f.updatesPaused){Ext.defer(f.loadMetrics,2000,f)}}})},getResponseTimeCls:function(b){var a=this.responseTimeClsLevels,d,c;for(d in a){if(!a.hasOwnProperty(d)){continue}if(b>=a[d]){c=d}else{break}}return c}});